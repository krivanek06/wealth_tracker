<div class="text-xl text-center" [ngClass]="{'mb-6': formGroup.controls.symbol.value}">
	<span>Operation </span>
	<span
		[ngClass]="{
      'text-wt-success-medium': formGroup.controls.isBuying.value,
      'text-wt-danger-medium': !formGroup.controls.isBuying.value
    }"
	>
		{{ formGroup.controls.isBuying.value ? 'Buy Asset' : 'Sell Asset' }}
	</span>
</div>

<div *ngIf="formGroup.controls.symbol.value" class="flex items-center justify-between px-2 lg:mb-4">
	<div class="text-lg">Owned units: {{ this.data.activeHolding?.units ?? 0 }}</div>
	<button mat-stroked-button type="button" (click)="onTransactionShow()" class="w-full lg:w-auto g-button-size-lg">
		<mat-icon>visibility</mat-icon>
		Show Previous Transactions
	</button>
</div>

<!-- error if more than cash -->
<div class="w-full mx-auto md:w-9/12">
	<div
		class="mt-2 mb-5 g-error-banner"
		*ngIf="formGroup.controls.symbol.touched && formGroup.controls.symbol.errors?.['required']"
	>
		Symbol name is required
	</div>
	<div class="mt-2 mb-5 g-error-banner" *ngIf="insufficientUnitsError$ | async">Insufficient units to sell</div>
</div>

<form (ngSubmit)="onSave()" [formGroup]="formGroup">
	<mat-dialog-content>
		<!-- historical chart -->
		<ng-container *ngIf="assetHistoricalData$ | async as assetHistoricalData; else chartSkeleton">
			<div *ngIf="!loadingHistoricalData; else chartSkeleton" class="min-h-[250px]">
				<app-generic-chart [series]="[assetHistoricalData]" [heightPx]="250"></app-generic-chart>
			</div>
		</ng-container>

		<!-- skeleton -->
		<ng-template #chartSkeleton>
			<div *ngIf="formSymbol.value" class="w-full h-[250px] g-skeleton"></div>
		</ng-template>

		<!-- cash state -->
		<div class="c-cash-wrapper">
			<div>
				<span class="text-gray-400">Units: </span>
				<span> {{ units.value || 'N/A' }} </span>
			</div>
			<div>
				<span class="text-gray-400">Price: </span>
				<span *ngIf="formSymbolPrice.value as value">~ {{ value | currency}} </span>
				<span *ngIf="!formSymbolPrice.value">N/A</span>
			</div>
			<div>
				<span class="text-gray-400">Total: </span>
				<span *ngIf="totalValue"> {{totalValue | currency }} </span>
				<span *ngIf="!totalValue">N/A</span>
			</div>
		</div>

		<div class="grid lg:grid-cols-2 gap-x-4 xl:gap-x-8">
			<div>
				<!-- date picker -->
				<app-date-picker formControlName="date" [inputTypeDateTimePickerConfig]="datePickerConfig"></app-date-picker>

				<!-- transaction type -->
				<div class="my-4">
					<button
						[disabled]="!data.activeHolding"
						type="button"
						mat-flat-button
						[color]="formGroup.controls.isBuying.value ? 'accent' : 'warn'"
						class="w-full"
						(click)="onTransactionTypeChange()"
					>
						{{ formGroup.controls.isBuying.value ? 'Buy Asset' : 'Sell Asset' }}
					</button>
				</div>

				<!-- asset type -->
				<app-form-mat-input-wrapper
					[disabled]="!!data.activeHolding"
					[inputSource]="TransactionAssetTypeInputSource"
					class="w-full"
					controlName="assetType"
					inputCaption="Select asset type"
					inputType="SELECT"
				></app-form-mat-input-wrapper>

				<!-- search symbol -->
				<app-asset-manager-search-asset
					formControlName="symbol"
					[isDisabled]="!!data.activeHolding"
					[searchableAsset]="formGroup.controls.assetType.value"
				></app-asset-manager-search-asset>
			</div>

			<div class="mt-10">
				<!-- keyboard -->
				<app-number-keyboard-control formControlName="units"></app-number-keyboard-control>
			</div>
		</div>

		<!-- history of asset holding -->
		<ng-container *ngIf="transactionHistory$ | async as transactionHistory">
			<div *ngIf="showHistoricalTransactions" class="min-h-[300px] sm:pl-4 md:pr-2 lg:col-span-2 mt-4">
				<div class="mb-2 text-base text-center text-wt-danger-medium">Historical data</div>
				<div class="text-xs text-center text-wt-gray-dark">Hold to remove</div>
				<div class="pt-3">
					<div *ngFor="let history of transactionHistory | sortByKey: 'date': 'desc'">
						<button
							mat-button
							appNotificationProgress
							[notificationProgressMessage]="'Removing entry from date: ' + (history.date | date: 'dd.MM.YYYY')"
							[notificationMessage]="'Removing data'"
							(notificationSuccessEmitter)="onDelete(history)"
							type="button"
							class="w-full mb-4 cursor-pointer h-14 lg:h-12"
						>
							<app-holding-history-item [history]="history"></app-holding-history-item>
						</button>
					</div>
				</div>
			</div>
		</ng-container>
	</mat-dialog-content>

	<div class="my-4">
		<mat-divider></mat-divider>
	</div>

	<!-- action buttons -->
	<mat-dialog-actions>
		<div class="g-mat-dialog-actions-full">
			<button mat-stroked-button mat-dialog-close type="button">Cancel</button>
			<button mat-stroked-button color="primary" type="submit" [disabled]="isError$ | async">
				<mat-icon *ngIf="isSaving" class="animate-spin">cached</mat-icon>
				Save
			</button>
		</div>
	</mat-dialog-actions>
</form>
