<app-dialog-close-header (dialogCloseEmitter)="onCancel()" title="Account Holdings"></app-dialog-close-header>

<!-- action buttons -->
<ng-container *ngIf="formGroup.controls.symbol.value">
	<app-action-buttons
		(transactionShowChangeEmitter)="onTransactionShow()"
		(transactionTypeChangeEmitter)="onTransactionTypeChange()"
		[showHistoricalTransactions]="showHistoricalTransactions"
		[isBuying]="formGroup.controls.isBuying.value"
	></app-action-buttons>
</ng-container>

<!-- error if more than cash -->
<div class="w-full mx-auto md:w-9/12">
	<div
		class="mt-2 g-error-banner"
		*ngIf="formGroup.controls.symbol.touched && formGroup.controls.symbol.errors?.['required']"
	>
		Symbol name is required
	</div>
	<div class="mt-2 mb-5 g-error-banner" *ngIf="insufficientUnitsError$ | async">Insufficient units to sell</div>
</div>

<form (ngSubmit)="onSave()" [formGroup]="formGroup">
	<mat-dialog-content>
		<ng-container *ngIf="!showHistoricalTransactions">
			<!-- selected symbol -->
			<div *ngIf="formGroup.controls.symbol.value as selectedSymbol" class="flex items-center py-3 space-x-2 sm:hidden">
				<img appDefaultImg [src]="selectedSymbol.symbolImageURL" alt="Symbol Image" class="h-7 w-7" />
				<span>{{ selectedSymbol.name }}</span>
			</div>

			<!-- historical chart -->
			<ng-container *ngIf="assetHistoricalData$ | async as assetHistoricalData; else chartSkeleton">
				<div *ngIf="!loadingHistoricalData; else chartSkeleton" class="min-h-[275px]">
					<app-generic-chart [series]="[assetHistoricalData]" [heightPx]="275"></app-generic-chart>
				</div>
			</ng-container>

			<!-- skeleton -->
			<ng-template #chartSkeleton>
				<div *ngIf="formSymbol.value" class="w-full h-[275px] g-skeleton"></div>
			</ng-template>

			<div class="flex items-center justify-end sm:justify-between">
				<!-- selected symbol -->
				<div class="items-center hidden gap-3 text-lg sm:flex">
					<div class="text-wt-primary-dark">Selected:</div>
					<div *ngIf="formGroup.controls.symbol.value as selectedSymbol" class="flex items-center space-x-2">
						<img appDefaultImg [src]="selectedSymbol.symbolImageURL" alt="Symbol Image" class="h-7 w-7" />
						<span>{{ selectedSymbol.name }}</span>
					</div>
				</div>

				<!-- checkbox for custom total value -->
				<div class="flex justify-end mt-4">
					<mat-checkbox
						color="primary"
						matTooltip="Allow manually set how many units you bought/sold and what was the total price"
						[formControl]="allowCustomTotalValue"
					>
						Allow Custom Total Value
					</mat-checkbox>
				</div>
			</div>

			<mat-divider></mat-divider>

			<!-- record state -->
			<div class="hidden sm:block">
				<ng-container *ngTemplateOutlet="recordState"></ng-container>
			</div>

			<div class="grid lg:grid-cols-2 gap-x-4 xl:gap-x-8">
				<div>
					<!-- date picker -->
					<app-date-picker formControlName="date" [inputTypeDateTimePickerConfig]="datePickerConfig"></app-date-picker>

					<!-- asset type -->
					<app-form-mat-input-wrapper
						[disabled]="!!data.activeHolding"
						[inputSource]="TransactionAssetTypeInputSource"
						class="w-full"
						controlName="assetType"
						inputCaption="Select asset type"
						inputType="SELECT"
					></app-form-mat-input-wrapper>

					<!-- search symbol -->
					<app-asset-manager-search-asset
						formControlName="symbol"
						[isDisabled]="!!data.activeHolding"
						[searchableAsset]="formGroup.controls.assetType.value"
					></app-asset-manager-search-asset>
				</div>

				<!-- record state -->
				<div class="block mt-4 sm:hidden">
					<ng-container *ngTemplateOutlet="recordState"></ng-container>
				</div>

				<div class="mt-6">
					<!-- keyboard -->
					<app-number-keyboard-control [formControl]="keyBoardFormControl"></app-number-keyboard-control>
				</div>
			</div>
		</ng-container>

		<!-- history of asset holding -->
		<ng-container *ngIf="transactionHistory$ | async as transactionHistory">
			<div *ngIf="showHistoricalTransactions" class="min-h-[300px] sm:pl-4 md:pr-2 lg:col-span-2 mt-4">
				<div class="mb-2 text-lg text-center text-wt-danger-medium">Historical data</div>
				<div class="text-sm text-center text-wt-gray-dark">Hold to remove</div>
				<div class="pt-3">
					<div *ngFor="let history of transactionHistory | sortByKey: 'date': 'desc'">
						<button
							mat-button
							appNotificationProgress
							[notificationProgressMessage]="'Removing entry from date: ' + (history.date | date: 'dd.MM.YYYY')"
							[notificationMessage]="'Removing data'"
							(notificationSuccessEmitter)="onDelete(history)"
							type="button"
							class="w-full mb-4 cursor-pointer h-14 lg:h-12"
						>
							<app-holding-history-item [history]="history"></app-holding-history-item>
						</button>
					</div>
				</div>
			</div>
		</ng-container>
	</mat-dialog-content>

	<div class="my-4">
		<mat-divider></mat-divider>
	</div>

	<!-- action buttons -->
	<mat-dialog-actions>
		<div class="g-mat-dialog-actions-full">
			<button mat-stroked-button mat-dialog-close type="button">Cancel</button>
			<button
				mat-stroked-button
				type="submit"
				[disabled]="isError$ | async"
				[color]="formGroup.controls.isBuying.value ? 'accent' : 'warn'"
			>
				<mat-icon *ngIf="isSaving" class="animate-spin">cached</mat-icon>
				Save
			</button>
		</div>
	</mat-dialog-actions>
</form>

<ng-template #recordState>
	<app-record-state
		(actionButtonPressEmitter)="onRecordStateAction($event)"
		[allowCustomization]="allowCustomTotalValue.value"
		[totalValue]="allowCustomTotalValue.value ? formGroup.controls.customTotalValue.value : calculatedTotalValue"
		[ownedUnitsShow]="!!data.activeHolding"
		[ownedUnits]="data.activeHolding?.units"
		[value]="formSymbolPrice.value"
		[units]="units.value"
		[isBuying]="formGroup.controls.isBuying.value"
	></app-record-state>
</ng-template>
